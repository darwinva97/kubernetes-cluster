# =============================================================================
# CONFIGURACIÓN DE ARGOCD (AUTOGESTIONADA)
# =============================================================================
# Este archivo es gestionado por ArgoCD después del bootstrap.
# Cualquier cambio aquí se aplica automáticamente.
# =============================================================================

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-cm
  namespace: argocd
  labels:
    app.kubernetes.io/name: argocd-cm
    app.kubernetes.io/part-of: argocd
data:
  # Método de tracking de recursos
  application.resourceTrackingMethod: annotation+label
  
  # URL de ArgoCD (cambiar por tu dominio)
  url: https://argocd.example.com
  
  # Timeout de reconciliación
  timeout.reconciliation: "180s"
  
  # Configuración de health checks personalizados
  resource.customizations.health.argoproj.io_Application: |
    hs = {}
    hs.status = "Progressing"
    hs.message = ""
    if obj.status ~= nil then
      if obj.status.health ~= nil then
        hs.status = obj.status.health.status
        if obj.status.health.message ~= nil then
          hs.message = obj.status.health.message
        end
      end
    end
    return hs

  # Ignorar diferencias globales
  resource.customizations.ignoreDifferences.all: |
    managedFieldsManagers:
      - argocd-controller
      - argocd-application-controller
      - kube-controller-manager
    jsonPointers:
      - /metadata/resourceVersion
      - /metadata/generation
      - /metadata/uid
      - /metadata/creationTimestamp
      - /metadata/managedFields

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-cmd-params-cm
  namespace: argocd
  labels:
    app.kubernetes.io/name: argocd-cmd-params-cm
    app.kubernetes.io/part-of: argocd
data:
  # Modo inseguro (TLS terminado en ingress)
  server.insecure: "true"
  
  # Procesadores de controlador
  controller.operation.processors: "10"
  controller.status.processors: "20"
  controller.repo.server.timeout.seconds: "60"
  
  # Configuración de logs
  controller.log.format: json
  server.log.format: json
  reposerver.log.format: json

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-rbac-cm
  namespace: argocd
  labels:
    app.kubernetes.io/name: argocd-rbac-cm
    app.kubernetes.io/part-of: argocd
data:
  # Política por defecto restrictiva
  policy.default: role:readonly
  
  # Políticas RBAC
  policy.csv: |
    # Admins tienen acceso total
    p, role:admin, applications, *, */*, allow
    p, role:admin, clusters, *, *, allow
    p, role:admin, repositories, *, *, allow
    p, role:admin, projects, *, *, allow
    p, role:admin, logs, *, *, allow
    p, role:admin, exec, *, *, allow
    
    # Developers pueden ver y sincronizar apps en su namespace
    p, role:developer, applications, get, */*, allow
    p, role:developer, applications, sync, */*, allow
    
    # Grupos
    g, argocd-admins, role:admin
    g, developers, role:developer
    
  scopes: "[groups, email]"

---
# Secret para repositorio Git (template)
# ⚠️ IMPORTANTE: En producción, usar Sealed Secrets o External Secrets
apiVersion: v1
kind: Secret
metadata:
  name: repo-gitops
  namespace: argocd
  labels:
    argocd.argoproj.io/secret-type: repository
type: Opaque
stringData:
  type: git
  url: git@github.com:darwinva97/kubernetes-cluster.git
  # SSH key se configura manualmente durante el bootstrap
  # NO commitear la clave privada aquí
